# Release workflow for Proliferate CLI
#
# Automatically builds and releases when CLI package changes on main.
# Also supports manual tag releases (git tag cli-v0.1.0 && git push origin cli-v0.1.0)
#
# This will:
# 1. Build binaries for all platforms using Deno
# 2. Create a GitHub release in the public proliferate-ai/cli repo
#
# Required secret: CLI_RELEASE_TOKEN (PAT with repo scope for proliferate-ai/cli)

name: Release CLI

on:
  workflow_dispatch:  # Allow manual triggering
  push:
    branches:
      - main
    paths:
      - "packages/cli/**"
      - ".github/workflows/release-cli.yml"
    tags:
      - "cli-v*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build - ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            platform: darwin-arm64
            deno_target: aarch64-apple-darwin
          - os: macos-15-large
            platform: darwin-x64
            deno_target: x86_64-apple-darwin
          - os: ubuntu-latest
            platform: linux-x64
            deno_target: x86_64-unknown-linux-gnu
          - os: ubuntu-24.04-arm
            platform: linux-arm64
            deno_target: aarch64-unknown-linux-gnu

    steps:
      - uses: actions/checkout@v6

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Build binary
        run: |
          cd packages/cli
          mkdir -p binaries
          deno compile --no-check --allow-all \
            --include=package.json \
            --target=${{ matrix.deno_target }} \
            --output=binaries/proliferate-${{ matrix.platform }} \
            src/index.ts

      - name: Create tarball
        run: |
          cd packages/cli/binaries
          tar -czvf proliferate-${{ matrix.platform }}.tar.gz proliferate-${{ matrix.platform }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: proliferate-${{ matrix.platform }}
          path: packages/cli/binaries/proliferate-${{ matrix.platform }}.tar.gz

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -name "*.tar.gz" -exec cp {} release/ \;
          ls -la release/

      - name: Extract version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/cli-v* ]]; then
            # From tag
            VERSION=${GITHUB_REF_NAME#cli-v}
          else
            # From package.json
            VERSION=$(jq -r '.version' packages/cli/package.json)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          repository: proliferate-ai/cli
          token: ${{ secrets.CLI_RELEASE_TOKEN }}
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body: |
            ## Proliferate CLI v${{ steps.version.outputs.version }}

            ### Installation

            ```bash
            curl -fsSL https://raw.githubusercontent.com/proliferate-ai/cli/main/install.sh | bash
            ```

            Or to install this specific version:
            ```bash
            curl -fsSL https://raw.githubusercontent.com/proliferate-ai/cli/main/install.sh | bash -s ${{ steps.version.outputs.version }}
            ```

            ### Manual Download

            Download the appropriate binary for your platform:
            - **macOS (Apple Silicon)**: `proliferate-darwin-arm64.tar.gz`
            - **macOS (Intel)**: `proliferate-darwin-x64.tar.gz`
            - **Linux (x64)**: `proliferate-linux-x64.tar.gz`
            - **Linux (ARM64)**: `proliferate-linux-arm64.tar.gz`

            Extract and move to your PATH:
            ```bash
            tar -xzf proliferate-<platform>.tar.gz
            mv proliferate-<platform> ~/.local/bin/proliferate
            chmod +x ~/.local/bin/proliferate
            ```
          files: release/*
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') }}
